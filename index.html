<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V√¥lei Pro V2.2 - Anti-Lag Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #f1c40f; --ultra: #00fbff; --bg: #1a1a1a; }
        body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; touch-action: none; height: 100vh; }
        .screen { display: none; position: absolute; inset: 0; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); z-index: 100; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .menu-box { background: #2c3e50; padding: 25px; border-radius: 20px; border: 3px solid var(--accent); width: 100%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .catalog-container { width: 95%; max-width: 700px; height: 85%; background: #2c3e50; border-radius: 15px; border: 3px solid var(--accent); overflow: hidden; display: flex; flex-direction: column; }
        .tabs { display: flex; background: #34495e; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: white; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; font-size: 12px; }
        .tab-btn.active-tab { border-bottom: 3px solid var(--accent); background: rgba(255,255,255,0.1); }
        .item-grid { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; overflow-y: auto; }
        .item-card { background: #1e272e; border-radius: 10px; padding: 12px; text-align: center; border: 2px solid transparent; }
        .item-card.equipped { border-color: var(--accent); background: #2d3436; }
        .btn-main { background: var(--accent); color: black; border: none; padding: 14px; margin: 6px 0; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; display: block; }
        #hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 50; }
        .hud-top { position: absolute; top: 15px; width: 100%; display: flex; justify-content: center; gap: 40px; font-weight: bold; font-size: 22px; }
        .btn-exit { position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; cursor: pointer; pointer-events: auto; z-index: 60; }
        .controls { position: absolute; bottom: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; pointer-events: auto; }
        .btn-act { width: 60px; height: 60px; background: rgba(0,0,0,0.6); border: 2px solid white; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        canvas { width: 100vw; height: 100vh; display: block; }
        #win-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        .win-text { font-size: 40px; color: var(--accent); text-shadow: 0 0 20px var(--accent); margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="screen-lobby" class="screen active">
    <div class="menu-box">
        <h1 style="color:var(--accent); margin-bottom:5px;">V√îLEI PRO</h1>
        <p style="margin-top:0;">üí∞ <span id="money-display">0</span></p>
        <button class="btn-main" onclick="startMode('friendly')">MODO TREINAMENTO</button>
        <button class="btn-main" style="background:#8e44ad; color:white;" onclick="setScreen('screen-multi-choice')">MULTIPLAYER</button>
        <button class="btn-main" style="background:#fff" onclick="openCatalog()">MEU CAT√ÅLOGO</button>
        <button class="btn-main" style="background:var(--ultra)" onclick="pullGacha()">ABRIR BA√ö ($150)</button>
    </div>
</div>

<div id="screen-multi-choice" class="screen">
    <div class="menu-box">
        <h2 style="color:var(--ultra)">MODOS ONLINE</h2>
        <button class="btn-main" onclick="startMode('multi-local')">MODO LOCAL (P2P)</button>
        <button class="btn-main" style="background:#2ecc71; color:white;" onclick="setScreen('screen-rooms')">SALAS PRIVADAS</button>
        <button class="btn-main" style="background:#95a5a6" onclick="setScreen('screen-lobby')">VOLTAR</button>
    </div>
</div>

<div id="screen-rooms" class="screen">
    <div class="menu-box">
        <h2 style="color:var(--accent)">SALAS ONLINE</h2>
        <button class="btn-main" style="background:#e67e22; color:white" onclick="hostRoom()">CRIAR SALA</button>
        <p id="room-code-display" style="font-family: monospace; font-size: 11px; color: var(--ultra); background: #1a1a1a; padding: 10px; border-radius: 5px; word-break: break-all; min-height: 20px;"></p>
        <input type="text" id="room-input" style="width:80%; padding:10px; border-radius:8px; border:none; text-align:center; margin-bottom:10px" placeholder="COLE O ID">
        <button class="btn-main" onclick="joinRoom()">ENTRAR</button>
        <button class="btn-main" style="background:#95a5a6; margin-top:10px" onclick="setScreen('screen-multi-choice')">VOLTAR</button>
    </div>
</div>

<div id="screen-catalog" class="screen">
    <div class="catalog-container">
        <div class="tabs">
            <button id="tab-arena" class="tab-btn active-tab" onclick="switchTab('arena')">ARENAS</button>
            <button id="tab-ball" class="tab-btn" onclick="switchTab('ball')">BOLAS</button>
            <button id="tab-skin" class="tab-btn" onclick="switchTab('skin')">SKINS</button>
        </div>
        <div id="catalog-grid" class="item-grid"></div>
        <button class="btn-main" style="border-radius:0; height: 60px; background: #e74c3c; color: white;" onclick="setScreen('screen-lobby')">SAIR</button>
    </div>
</div>

<div id="screen-game" class="screen" style="padding:0">
    <button class="btn-exit" onclick="quitGame()">X</button>
    <canvas id="gameCanvas"></canvas>
    <div id="hud">
        <div class="hud-top">
            <span style="color: #ff4757">P1: <span id="p1-score">0</span></span>
            <span style="color: #2e86de">P2: <span id="p2-score">0</span></span>
        </div>
        <div class="controls">
            <div style="display: flex; gap: 10px;">
                <div class="btn-act" id="m-left">‚Üê</div>
                <div class="btn-act" id="m-right">‚Üí</div>
                <div class="btn-act" style="background: rgba(255,255,255,0.2); width: 80px; border-radius: 10px;" id="m-dive">DIVE</div>
            </div>
            <div class="btn-act" style="background:var(--accent); color:black;" id="m-jump">PULO</div>
        </div>
    </div>
</div>

<div id="win-screen">
    <div class="win-text" id="winner-label">P1 VENCEU!</div>
    <div style="width: 220px">
        <button class="btn-main" id="btn-revanche" onclick="requestRematch()">REVANCHE (0/2)</button>
        <button class="btn-main" style="background:#95a5a6" onclick="quitGame()">SAIR</button>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800; canvas.height = 400;

let peer = null, conn = null, isHost = false;
let shake = 0, rematchVotes = {p1: false, p2: false};
let clientInputs = {left: false, right: false, jump: false, dive: false};
let clientSkin = 'skin_default';
let netInterval = null; // Timer para rede

const ITEMS = [
    {id:'arena_verde', name:'Gramado', type:'arena', icon:'üåµ', color: '#2ecc71'},
    {id:'arena_noite', name:'Noite', type:'arena', icon:'üåë', color: '#1a1a2e'},
    {id:'arena_rua', name:'Rua', type:'arena', icon:'üåá', color: '#e67e22'},
    {id:'ball_normal', name:'Comum', type:'ball', icon:'üèê', color: 'white'},
    {id:'ball_crystal', name:'Cristal', type:'ball', icon:'üíé', color: '#00fbff'},
    {id:'skin_default', name:'Padr√£o', type:'skin', icon:'üë§', color:'red'},
    {id:'skin_ninja', name:'Ninja', type:'skin', icon:'ü•∑', color:'#2c3e50'},
    {id:'skin_robot', name:'Rob√¥', type:'skin', icon:'ü§ñ', color:'#95a5a6'}
];

let game = {
    money: parseInt(localStorage.getItem('v19_money')) || 500,
    inv: JSON.parse(localStorage.getItem('v19_inv')) || ['arena_verde', 'ball_normal', 'skin_default'],
    eq: { arena:'arena_verde', ball:'ball_normal', skin:'skin_default' },
    active: false, mode: 'friendly', scoreP1: 0, scoreP2: 0, lastWinner: 'p1', currentTab: 'arena'
};

let ball = {x:400, y:120, vx:0, vy:0};
let p1 = {x:100, y:360, vy:0, dash:0}, p2 = {x:650, y:360, vy:0, dash:0};
let inputs = {left: false, right: false, jump: false, dive: false};

// --- REDE (MELHORADO) ---
function hostRoom() {
    peer = new Peer();
    peer.on('open', id => { document.getElementById('room-code-display').innerText = id; });
    peer.on('connection', c => { conn = c; isHost = true; setupConn(); startMode('multi-online'); });
}

function joinRoom() {
    const id = document.getElementById('room-input').value;
    if(!id) return alert("Cole o ID!");
    peer = new Peer();
    peer.on('open', () => { conn = peer.connect(id); isHost = false; setupConn(); startMode('multi-online'); });
}

function setupConn() {
    conn.on('open', () => { 
        conn.send({type:'sync_init', eq: game.eq}); 
        // Inicia o loop de rede est√°vel (20ms)
        if(netInterval) clearInterval(netInterval);
        netInterval = setInterval(networkUpdate, 40); 
    });
    
    conn.on('data', data => {
        if(data.type === 'sync_init') { clientSkin = data.eq.skin; }
        else if(data.type === 'rematch_vote') { rematchVotes[data.role] = true; checkRematch(); }
        else if(isHost) {
            clientInputs = data; // Host recebe as teclas do Client
        } else { 
            // Client recebe posi√ß√µes do Host
            ball = data.ball; p1 = data.p1; p2 = data.p2; 
            game.scoreP1 = data.scoreP1; game.scoreP2 = data.scoreP2; 
        }
    });
}

// Fun√ß√£o que roda fora do requestAnimationFrame para n√£o travar em abas ocultas
function networkUpdate() {
    if(!conn || !conn.open) return;
    if(isHost) {
        conn.send({ball, p1, p2, scoreP1:game.scoreP1, scoreP2:game.scoreP2});
    } else {
        conn.send(inputs);
    }
}

function startMode(m) {
    game.mode = m; game.scoreP1 = 0; game.scoreP2 = 0;
    setScreen('screen-game');
    document.getElementById('hud').style.display = 'block';
    game.active = true; spawnBall();
}

function updatePhys(p, inp, side) {
    let s = p.dash > 0 ? 11 : 5;
    if(p.dash > 0) p.dash--;
    if(inp.left) p.x -= s; if(inp.right) p.x += s;
    if(inp.jump && p.y >= 360) { p.vy = -10; inp.jump = false; } // Reset jump after use
    if(inp.dive && p.dash <= 0) { p.dash = 20; inp.dive = false; } // Reset dive after use
    p.vy += 0.35; p.y += p.vy;
    if(p.y >= 360) { p.y = 360; p.vy = 0; }
    p.x = (side==='l') ? Math.max(0, Math.min(355, p.x)) : Math.max(405, Math.min(755, p.x));
}

function loop() {
    if(game.active) {
        // Apenas o Host processa a f√≠sica no modo Online
        if(isHost || game.mode !== 'multi-online') {
            updatePhys(p1, inputs, 'l');
            if(game.mode==='friendly') {
                let bi = {left: ball.x>360 && p2.x>ball.x, right: ball.x>360 && p2.x<ball.x, jump: ball.y<250 && Math.abs(ball.x-p2.x)<50};
                updatePhys(p2, bi, 'r');
            } else {
                updatePhys(p2, clientInputs, 'r');
            }
            ball.vy += 0.22; ball.x += ball.vx; ball.y += ball.vy;
            if(ball.x<10 || ball.x>790) ball.vx *= -1;
            [p1, p2].forEach(p => {
                if(ball.x > p.x && ball.x < p.x+45 && ball.y+10 > p.y-65 && ball.y-10 < p.y) {
                    ball.vy = -9; ball.vx = (ball.x - (p.x+22)) * 0.45;
                }
            });
            if(ball.x>395 && ball.x<405 && ball.y>280) { ball.vx *= -1.2; ball.x = ball.x<400?385:415; }
            if(ball.y > 395) {
                if(ball.x < 400) { game.scoreP2++; game.lastWinner='p2'; }
                else { game.scoreP1++; game.lastWinner='p1'; }
                shake = 10;
                if(game.scoreP1>=10 || game.scoreP2>=10) {
                    game.active = false;
                    document.getElementById('win-screen').style.display = 'flex';
                    document.getElementById('winner-label').innerText = game.scoreP1>=10?"P1 VENCEU!":"P2 VENCEU!";
                } else spawnBall();
            }
        }

        // --- RENDERIZA√á√ÉO ---
        ctx.save();
        if(shake>0) { ctx.translate(Math.random()*shake, Math.random()*shake); shake *= 0.8; }
        let ar = ITEMS.find(i=>i.id===game.eq.arena);
        ctx.fillStyle = ar.color; ctx.fillRect(0,0,800,400);
        ctx.fillStyle = '#d4a373'; ctx.fillRect(0,360,800,40);
        ctx.fillStyle = 'white'; ctx.fillRect(398,280,4,80);
        
        // Player 1
        ctx.fillStyle = ITEMS.find(i=>i.id===game.eq.skin).color;
        ctx.fillRect(p1.x, p1.y-65, 45, 65);
        
        // Player 2
        ctx.fillStyle = (game.mode.includes('multi')) ? ITEMS.find(i=>i.id===clientSkin).color : 'blue';
        ctx.fillRect(p2.x, p2.y-65, 45, 65);

        // Bola
        ctx.fillStyle = ITEMS.find(i=>i.id===game.eq.ball).color;
        ctx.beginPath(); ctx.arc(ball.x, ball.y, 10, 0, Math.PI*2); ctx.fill();
        ctx.restore();
        
        document.getElementById('p1-score').innerText = game.scoreP1;
        document.getElementById('p2-score').innerText = game.scoreP2;
    }
    requestAnimationFrame(loop);
}

// --- UI & CATALOG ---
function setScreen(id) { 
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById('money-display').innerText = game.money;
}
function openCatalog() { setScreen('screen-catalog'); renderCatalog(); }
function switchTab(t) { 
    game.currentTab = t; 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
    document.getElementById('tab-'+t).classList.add('active-tab');
    renderCatalog(); 
}
function renderCatalog() {
    const grid = document.getElementById('catalog-grid'); grid.innerHTML = '';
    ITEMS.filter(i => i.type === game.currentTab).forEach(item => {
        const owned = game.inv.includes(item.id); const eq = game.eq[item.type] === item.id;
        grid.innerHTML += `<div class="item-card ${eq?'equipped':''}">
            <div style="font-size:30px">${item.icon}</div>
            <div style="font-size:10px; margin:5px 0">${item.name}</div>
            <button class="btn-main" style="font-size:10px" ${!owned?'disabled':''} onclick="equip('${item.type}','${item.id}')">
            ${eq?'EQUIPADO':(owned?'USAR':'BLOQUEADO')}</button></div>`;
    });
}
function equip(t, id) { game.eq[t] = id; renderCatalog(); localStorage.setItem('v19_eq', JSON.stringify(game.eq)); }
function pullGacha() {
    if(game.money<150) return alert("Sem moedas!");
    game.money-=150; let pool = ITEMS.filter(i=>!game.inv.includes(i.id));
    if(pool.length>0) { let it = pool[Math.floor(Math.random()*pool.length)]; game.inv.push(it.id); alert("Ganhou: "+it.name); }
    localStorage.setItem('v19_money', game.money); localStorage.setItem('v19_inv', JSON.stringify(game.inv));
    document.getElementById('money-display').innerText = game.money;
}

function spawnBall() { ball = {x: game.lastWinner==='p1'?p1.x+22 : p2.x+22, y:120, vx:0, vy:0}; }
function quitGame() { 
    game.active = false; 
    if(conn) conn.close(); 
    if(netInterval) clearInterval(netInterval);
    setScreen('screen-lobby'); 
    document.getElementById('win-screen').style.display='none'; 
}
function requestRematch() { if(game.mode==='friendly') { resetMatch(); return; } rematchVotes[isHost?'p1':'p2']=true; if(conn) conn.send({type:'rematch_vote', role:isHost?'p1':'p2'}); checkRematch(); }
function checkRematch() { let c=(rematchVotes.p1?1:0)+(rematchVotes.p2?1:0); document.getElementById('btn-revanche').innerText=`REVANCHE (${c}/2)`; if(rematchVotes.p1&&rematchVotes.p2) resetMatch(); }
function resetMatch() { game.scoreP1=0; game.scoreP2=0; game.active=true; rematchVotes={p1:false,p2:false}; document.getElementById('win-screen').style.display='none'; spawnBall(); }

// Controles corrigidos para n√£o resetar o estado prematuramente
const bH = (id, s) => { 
    const e = document.getElementById(id); 
    e.onpointerdown = (ev) => { ev.preventDefault(); inputs[s] = true; };
    e.onpointerup = (ev) => { ev.preventDefault(); inputs[s] = false; };
};
bH('m-left', 'left'); bH('m-right', 'right');
document.getElementById('m-jump').onpointerdown = (ev) => { ev.preventDefault(); inputs.jump = true; };
document.getElementById('m-dive').onpointerdown = (ev) => { ev.preventDefault(); inputs.dive = true; };

setScreen('screen-lobby'); loop();
</script>
</body>
</html>


    
            
